---
title: jap-oauth2-spring-boot-starter æ¨¡å—ä½¿ç”¨å¸®åŠ©
permalink: /starter/jap-oauth2-spring-boot-starter/
sidebar: true
article: true
comment: true
categories:
- æŒ‡å—
- starter
  tags:
- jap-ids
- springboot
- starter
  date: 2021-10-12 14:05:06
---

# jap-oauth2-spring-boot-starter

ä¸º[JustAuth Plus](https://justauth.plus/) çš„ ***oauth2*** æˆæƒç­–ç•¥å¼€å‘çš„Spring Boot Starterä¾èµ–ã€‚

å¯è®¿é—®æœ¬starterçš„[demo](https://github.com/Vector6662/jap-spring-boot-starter-demo) ï¼ŒåŒ…å«è¾ƒä¸ºè¯¦å°½çš„è°ƒç”¨æµç¨‹å’Œç›¸å…³é…ç½®è¯´æ˜ã€‚

## å¼€æºä»“åº“åœ°å€ï¼š

[GitHub](https://github.com/fujieid/jap-spring-boot-starter)

[Gitee](https://gitee.com/fujieid/jap-spring-boot-starter-demo)

## å¿«é€Ÿå¼€å§‹

### å¼•å…¥ä¾èµ–

åœ¨ä½ é¡¹ç›®çš„ *pom.xml* æ–‡ä»¶ä¸­æ·»åŠ jap-socialçš„starterçš„mavenä¾èµ–ï¼š

```xml
<dependency>
    <groupId>xyz.dong6662.jap.spring.boot</groupId>
    <artifactId>jap-oauth2-spring-boot-starter</artifactId>
    <version>1.0.0</version>
</dependency>
```

### application.propertiesä¸­é…ç½®

é¦–å…ˆåœ¨ *application.properties* æ–‡ä»¶ä¸­å®Œæˆä¸€äº›åŸºæœ¬é…ç½®ï¼Œè¿™äº›é…ç½®ä¿¡æ¯æ‰€æœ‰æˆæƒç­–ç•¥å‡ä¼šä½¿ç”¨åˆ°ï¼š

```properties
# åŸºç¡€é…ç½®
# å¦‚æœå¯å¯ç”¨äº†ssoï¼Œåˆ™éœ€è¦å¯¹ssoè¿›è¡Œä¸€äº›é…ç½®
jap.basic.sso=false
jap.basic.cache-expire-time=12
jap.basic.token-expire-time=12
# sso
jap.sso.cookie-domain=xxx
jap.sso.cookie-max-age=xxx
jap.sso.cookie-name=xxx
```

ç„¶åï¼Œä¸ºoauth2ç­–ç•¥æ·»åŠ å®ƒçš„é…ç½®ä¿¡æ¯ï¼Œä¸‹é¢ä»¥giteeå¹³å°ä¸ºä¾‹ï¼Œå±•ç¤º**æˆæƒç **æ–¹å¼çš„é…ç½®ä¿¡æ¯ï¼š

```properties
# oauth2ç­–ç•¥

# giteeå¹³å°ï¼Œç›¸å…³apiåœ¨ https://gitee.com/api/v5/oauth_doc#/
# æˆæƒç æ–¹å¼ï¼Œæ­¤æ–¹å¼ä¸‹response-typeéœ€ä¸ºtype
jap.oauth2[0].platform=gitee
jap.oauth2[0].grant-type=authorization_code
jap.oauth2[0].response-type=code
jap.oauth2[0].client-id=e9b4f19402d2ccb3375f5be19b9c76738fffe071d6b450a65dc4baa70a7ab752
jap.oauth2[0].client-secret=83bd48fc1ec9807f769c6328304e6222f2290b57d60f346a24976b48a752b794
# ä»gitee oauthæœåŠ¡è·å–æˆæƒç codeçš„åœ°å€
jap.oauth2[0].authorization-url=https://gitee.com/oauth/authorize
# ä½ çš„åº”ç”¨æœåŠ¡å™¨æ¥æ”¶codeçš„åœ°å€
jap.oauth2[0].callback-url=http://localhost:8080/oauth/gitee/authorization-code
# è·å–tokençš„åœ°å€
jap.oauth2[0].token-url=https://gitee.com/oauth/token
jap.oauth2[0].userinfo-url=https://gitee.com/api/v5/user
# è·å–user infoçš„æ–¹æ³•ï¼ŒGETã€POSTç­‰ã€‚æ¯ä¸ªplatformçš„ä¸ä¸€æ ·ï¼Œéœ€è¦æŸ¥çœ‹å…·ä½“å¹³å°çš„API
jap.oauth2[0].user-info-endpoint-method-type=get
# å¦‚æœè®¿é—®authorization-urlæ²¡æœ‰å¸¦ä¸Šstateå‚æ•°ï¼Œè¿™é‡Œéœ€è¦è®¾ä¸ºfalse
jap.oauth2[0].verify-state=false
```

å…¶ä»–å…¶ä¸­æˆæƒæ–¹å¼ï¼Œå¦‚passwordã€implicitä¹Ÿç±»ä¼¼ï¼Œå¯å‚è€ƒdemoã€‚

### å®ç°JapUserServiceæ¥å£

ä¸jap-oauth2å®ç°JapUserServiceæ¥å£ä¸åŒçš„æ˜¯ï¼ŒğŸˆ**ä½ ä¸ä»…éœ€è¦ä¸ºè¯¥å®ç°ç±»æ·»åŠ `@Service`æ³¨è§£ï¼Œè¿˜éœ€è¦å¯¹è¯¥æ³¨è§£æ·»åŠ å‚æ•°`JapUserServiceType.Oauth2`**ï¼Œè¡¨æ˜è¿™æ˜¯oauth2ç­–ç•¥çš„å®ç°ç±»ï¼š

```java
@Service(JapUserServiceType.OAUTH2)
public class Oauth2UserServiceImpl implements JapUserService {

    /**
     * æ¨¡æ‹Ÿ DB æ“ä½œ
     */
    private static final List<JapUser> userDatas = Lists.newArrayList();

    /**
     * æ ¹æ®ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†ï¼ˆplatformï¼‰å’Œç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ· uid æŸ¥è¯¢æ•°æ®åº“
     *
     * @param platform ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†
     * @param uid      ç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ· uid
     * @return JapUser
     */
    @Override
    public JapUser getByPlatformAndUid(String platform, String uid) {
        // FIXME æ³¨æ„ï¼šæ­¤å¤„ä»…ä½œæ¼”ç¤ºç”¨ï¼Œå¹¶æ²¡æœ‰åˆ¤æ–­ platformï¼Œå®é™…ä¸šåŠ¡ç³»ç»Ÿä¸­éœ€è¦æ ¹æ® platform å’Œ uid è¿›è¡Œè·å–å”¯ä¸€ç”¨æˆ·
        return userDatas.stream().filter(user -> user.getUserId().equals(uid)).findFirst().orElse(null);
    }

    /**
     * åˆ›å»ºå¹¶è·å–ç¬¬ä¸‰æ–¹ç”¨æˆ·ï¼Œç›¸å½“äºç¬¬ä¸‰æ–¹ç™»å½•æˆåŠŸåï¼Œå°†æˆæƒå…³ç³»ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå¼€å‘è€…ä¸šåŠ¡ç³»ç»Ÿä¸­ oauth2 user -> sys user çš„ç»‘å®šå…³ç³»ï¼‰
     *
     * @param platform ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†
     * @param userInfo JustAuth ä¸­çš„ AuthUser
     * @return JapUser
     */
    @Override
    public JapUser createAndGetOauth2User(String platform, Map<String, Object> userInfo, Object tokenInfo) {
        // FIXME ä¸šåŠ¡ç«¯å¯ä»¥å¯¹ tokenInfo è¿›è¡Œä¿å­˜æˆ–å…¶ä»–æ“ä½œ
        AccessToken accessToken = (AccessToken) tokenInfo;
        System.out.println(JsonUtil.toJsonString(accessToken));
        // FIXME æ³¨æ„ï¼šæ­¤å¤„ä»…ä½œæ¼”ç¤ºç”¨ï¼Œä¸åŒçš„ oauth å¹³å°ç”¨æˆ·idéƒ½ä¸ä¸€æ ·ï¼Œæ­¤å¤„éœ€è¦å¼€å‘è€…è‡ªå·±åˆ†æç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæå–å‡ºç”¨æˆ·çš„å”¯ä¸€ID
        String uid = (String) userInfo.get("userId");
        // æŸ¥è¯¢ç»‘å®šå…³ç³»ï¼Œç¡®å®šå½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•è¿‡ä¸šåŠ¡ç³»ç»Ÿ
        JapUser japUser = this.getByPlatformAndUid(platform, uid);
        if (null == japUser) {
            japUser = createJapUser();
            japUser.setAdditional(userInfo);
            userDatas.add(japUser);
        }
        return japUser;
    }

    private JapUser createJapUser() {
        JapUser user = new JapUser();
        user.setUserId("1");
        user.setUsername("justauth");
        user.setPassword("justauthpassword");
        return user;
    }

}
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ *application.properties* ä¸­æŒ‡å®šoauth2ç­–ç•¥çš„`JapUserService`å®ç°ç±»ï¼Œå³æŒ‡å®šè¯¥å®ç°ç±»çš„åŒ…å…¨åï¼ˆbinary nameï¼‰ï¼š

```properties
jap.oauth2-user-service=xyz.dong6662.japspringbootstarterdemo.service.Oauth2UserServiceImpl
```

### å®ç°Controller

```java
@RestController
@RequestMapping("/oauth")
public class Oauth2Controller {
    @Autowired
    Oauth2Strategy oauth2Strategy;
    @Autowired
    Oauth2Properties oauth2Properties;

    /**
     * é˜¿é‡Œäº‘ AuthorizationCodeæˆæƒæ–¹å¼
     * @return
     */
    @RequestMapping("/aliyun/authorization-code")
    public JapResponse aliyunAuthorizationCode(HttpServletRequest request, HttpServletResponse response){
        return oauth2Strategy.authenticate(oauth2Properties.getOauth2().get(3), request, response);
    }

    @RequestMapping("/aliyun/refresh-token")
    public JapResponse aliyunRefreshToken(HttpServletRequest request, HttpServletResponse response) {
        // è¿™æ˜¯è·å–JapUserçš„ä¸€ç§æ–¹å¼
        JapUser japUser = japUserStore.get(request, response);
        // FIXME: aliyunå¹³å°ä¸ä¼šåœ¨æˆæƒä¿¡æ¯ä¸­è¿”å›refresh_tokenï¼Œå› æ­¤è¿™é‡ŒrefreshTokençš„æ˜¯ä¸ºnull
        String refreshToken = ((Kv) japUser.getAdditional()).getString("refresh-token");
        return oauth2Strategy.refreshToken(oauth2Properties.getOauth2().get(3), refreshToken);
    }
}
```

## ä½¿ç”¨JapTemplate

è¿™æ˜¯ä¸ºäº†ç®€åŒ–å››ç§æˆæƒç­–ç•¥çš„è°ƒç”¨è€Œå¼€å‘çš„starterä¾èµ–ã€‚åªéœ€åœ¨å¼•å…¥äº†jap-oauth2çš„mavenä¾èµ–çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥ *JapTemplate*çš„ä¾èµ–ä¾¿å¯ä½¿ç”¨ï¼š

```xml
<dependency>
    <groupId>xyz.dong6662.jap.spring.boot</groupId>
    <artifactId>jap-spring-boot-starter-template</artifactId>
    <version>1.0.0</version>
</dependency>
```

è¿™æ ·ï¼Œåœ¨Controllerä¸­çš„æˆæƒä»£ç åªéœ€ä¸€è¡Œä¾¿å¯å®Œæˆæˆæƒï¼š

```java
@RestController
@RequestMapping("/oauth")
public class Oauth2Controller {
    @Autowired
    JapTemplate japTemplate;
    @Autowired
    JapUserStore japUserStore;

    /**
     * gitee AuthorizationCodeæˆæƒæ–¹å¼
     */
    @RequestMapping("/gitee/authorization-code") //callback-url
    public JapResponse authorizationCode(){
        return japTemplate.opsForOauth2().authenticateByAuthorizationCode("gitee");
    }

    /**
     * gitee passwordæˆæƒæ–¹å¼
     */
    @RequestMapping("/gitee/password")
    public JapResponse passwordGrantType(String username, String password) {
        return japTemplate.opsForOauth2().authenticateByPassword("gitee", username, password);
    }

    @RequestMapping("/gitee/refresh-token")
    public JapResponse refreshToken(HttpServletRequest request, HttpServletResponse response){
        // è¿™æ˜¯è·å–JapUserçš„ä¸€ç§æ–¹å¼
        JapUser japUser = japUserStore.get(request, response);
        // FIXME: 2021/9/25 giteeå¹³å°ä¸ä¼šåœ¨æˆæƒä¿¡æ¯ä¸­è¿”å›refresh_token
        String refreshToken = ((Kv) japUser.getAdditional()).getString("refresh-token");
        return japTemplate.opsForOauth2().refreshToken("gitee",refreshToken);
    }

    /**
     * github AuthorizationCodeæˆæƒæ–¹å¼
     * @return
     */
    @RequestMapping("/github/authorization-code")
    public JapResponse github(){
        // FIXME: 2021/9/25 GitHubçš„æˆæƒæ–¹å¼ä¼¼ä¹å¹¶ä¸æ˜¯ä¸¥æ ¼çš„oauth2ï¼ŒæŸ¥çœ‹ï¼šhttps://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#response
        //  ä¼šå‘ç°é»˜è®¤æƒ…å†µä¸‹è¿”å›çš„æˆæƒä¿¡æ¯ä¸æ˜¯jsonæ ¼å¼ï¼Œè€Œæ˜¯ç±»ä¼¼è¿™æ ·ï¼šaccess_token=XXX&token_type=bearer
        return japTemplate.opsForOauth2().authenticateByAuthorizationCode("github");
    }
}
```

## å¼•å…¥Redisç¼“å­˜

oauth2å’Œoidcæˆæƒç­–ç•¥éƒ½ä¼šç¼“å­˜tokenï¼Œé™¤äº†é»˜è®¤çš„ç¼“å­˜ç±»å‹ï¼ˆdefaultï¼‰å¤–ï¼Œæœ¬starterè¿˜æ”¯æŒRedisä½œä¸ºç¼“å­˜ã€‚è‹¥é‡‡ç”¨Redisæ–¹å¼ï¼Œéœ€è¦å¼•å…¥Redisçš„Spring Boot Starterï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

å¹¶åœ¨*application.properties*ä¸­å®Œæˆredisçš„ä¸€äº›åŸºæœ¬é…ç½®ï¼š

```properties
# redisåŸºç¡€é…ç½®
spring.redis.port=6379
spring.redis.host=127.0.0.1
spring.redis.timeout=3m
```

ç„¶åæŒ‡å®šRedisä½œä¸ºtokençš„ç¼“å­˜å³å¯ï¼š

```properties
# tokenç¼“å­˜
jap.cache.token.type=redis
jap.cache.token.expire-time=3m
```

