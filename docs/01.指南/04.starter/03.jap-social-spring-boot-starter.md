---
title: jap-social-spring-boot-starter æ¨¡å—ä½¿ç”¨å¸®åŠ©
permalink: /starter/jap-social-spring-boot-starter/
sidebar: true
article: true
comment: true
categories:
- æŒ‡å—
- starter
  tags:
- jap-ids
- springboot
- starter
  date: 2021-10-12 14:05:06
---

# jap-social-spring-boot-starter

ä¸º[JustAuth Plus](https://justauth.plus/) çš„ ***social*** æˆæƒç­–ç•¥å¼€å‘çš„Spring Boot Starterä¾èµ–ã€‚

å¯è®¿é—®æœ¬starterçš„[demo](https://github.com/Vector6662/jap-spring-boot-starter-demo) ï¼ŒåŒ…å«è¾ƒä¸ºè¯¦å°½çš„è°ƒç”¨æµç¨‹å’Œç›¸å…³é…ç½®è¯´æ˜ã€‚

## å¼€æºä»“åº“åœ°å€ï¼š

[GitHub](https://github.com/fujieid/jap-spring-boot-starter)

[Gitee](https://gitee.com/fujieid/jap-spring-boot-starter-demo)

## å¿«é€Ÿå¼€å§‹

### å¼•å…¥ä¾èµ–

åœ¨ä½ é¡¹ç›®çš„ *pom.xml* æ–‡ä»¶ä¸­æ·»åŠ jap-socialçš„starterçš„mavenä¾èµ–ï¼š

```xml
<dependency>
    <groupId>xyz.dong6662.jap.spring.boot</groupId>
    <artifactId>jap-social-spring-boot-starter</artifactId>
    <version>1.0.0</version>
</dependency>
```

### application.propertiesä¸­é…ç½®

é¦–å…ˆåœ¨ *application.properties* æ–‡ä»¶ä¸­å®Œæˆä¸€äº›åŸºæœ¬é…ç½®ï¼Œè¿™äº›é…ç½®ä¿¡æ¯æ‰€æœ‰æˆæƒç­–ç•¥å‡ä¼šä½¿ç”¨åˆ°ï¼š

```properties
# åŸºç¡€é…ç½®
# å¦‚æœå¯å¯ç”¨äº†ssoï¼Œåˆ™éœ€è¦å¯¹ssoè¿›è¡Œä¸€äº›é…ç½®
jap.basic.sso=false
jap.basic.cache-expire-time=12
jap.basic.token-expire-time=12
# sso
jap.sso.cookie-domain=xxx
jap.sso.cookie-max-age=xxx
jap.sso.cookie-name=xxx
```

ç„¶åï¼Œä¸ºsocialç­–ç•¥æ·»åŠ å®ƒçš„é…ç½®ä¿¡æ¯ï¼Œä¸‹é¢æ˜¯giteeå¹³å°å’Œ[é˜¿é‡Œäº‘RAM](https://ram.console.aliyun.com/overview)çš„é…ç½®ä¿¡æ¯ï¼š

```properties
# socialç­–ç•¥

# social ç¼“å­˜
jap.social.cache.type=default

# giteeå¹³å°
jap.social.gitee.platform=gitee
jap.social.gitee.state=fdefc
jap.social.gitee.just-auth-config.client-id=228d103043840b9706f04ad165726a0079c7e0263bf7c11f1205b4054ff094a9
jap.social.gitee.just-auth-config.client-secret=a06ccbdef86d193f25dc240d3e0a9038801ff3cf4c40937f2b58904c8f32a298
jap.social.gitee.just-auth-config.redirect-uri=http://localhost:8080/social/gitee
jap.social.gitee.just-auth-config.ignore-check-state=true

# é˜¿é‡Œäº‘å¹³å°
# å¯å‚è€ƒ https://help.aliyun.com/document_detail/93696.html
jap.social.aliyun.platform=aliyun
jap.social.aliyun.state=1f334ee76ba98fc5e8d62854cecf5d25P7ZKCJ5F2Dc_idp
jap.social.aliyun.just-auth-config.client-id=4330480533918027749
jap.social.aliyun.just-auth-config.client-secret=qsw5CWGXHAb4kGW9loPWWTO7i3xgzDALcCpVxDCCVCVXSHNN8BbG7NFji7O4J6XO
jap.social.aliyun.just-auth-config.redirect-uri=http://localhost:8080/social/aliyun
jap.social.aliyun.just-auth-config.ignore-check-state=true
```

socialç­–ç•¥ä¼šç¼“å­˜å·²ç»ç™»å½•çš„`AuthUser`å®ä¾‹ï¼ŒJustAuth Plusæ¡†æ¶æä¾›äº†ä¸‰ç§ç¼“å­˜ç±»å‹ï¼Œç¨åä¼šæåˆ°å¦‚ä½•æ›´æ”¹ã€‚

### å®ç°JapUserServiceæ¥å£

ä¸[jap-socialå®ç°JapUserServiceæ¥å£](https://justauth.plus/quickstart/jap-social/#%E5%AE%9E%E7%8E%B0-japuserservice-%E6%8E%A5%E5%8F%A3)ä¸åŒçš„æ˜¯ï¼ŒğŸˆ**ä½ ä¸ä»…éœ€è¦ä¸ºè¯¥å®ç°ç±»æ·»åŠ `@Service`æ³¨è§£ï¼Œè¿˜éœ€è¦å¯¹è¯¥æ³¨è§£æ·»åŠ å‚æ•°`JapUserServiceType.SOCIAL`**ï¼Œè¡¨æ˜è¿™æ˜¯socialç­–ç•¥çš„å®ç°ç±»ï¼š

```java
@Service(JapUserServiceType.SOCIAL)
public class SocialUserServiceImpl implements JapUserService {
    /**
     * æ¨¡æ‹Ÿ DB æ“ä½œ
     */
    private static List<JapUser> userDatas = Lists.newArrayList();

    /**
     * æ ¹æ®ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†ï¼ˆplatformï¼‰å’Œç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ· uid æŸ¥è¯¢æ•°æ®åº“
     *
     * @param platform ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†
     * @param uid      ç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ· uid
     * @return JapUser
     */
    @Override
    public JapUser getByPlatformAndUid(String platform, String uid) {
        // FIXME æ³¨æ„ï¼šæ­¤å¤„ä»…ä½œæ¼”ç¤ºç”¨ï¼Œå¹¶æ²¡æœ‰åˆ¤æ–­ platformï¼Œå®é™…ä¸šåŠ¡ç³»ç»Ÿä¸­éœ€è¦æ ¹æ® platform å’Œ uid è¿›è¡Œè·å–å”¯ä¸€ç”¨æˆ·
        return userDatas.stream().filter(user -> user.getUserId().equals(uid)).findFirst().orElse(null);
    }

    /**
     * åˆ›å»ºå¹¶è·å–ç¬¬ä¸‰æ–¹ç”¨æˆ·ï¼Œç›¸å½“äºç¬¬ä¸‰æ–¹ç™»å½•æˆåŠŸåï¼Œå°†æˆæƒå…³ç³»ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå¼€å‘è€…ä¸šåŠ¡ç³»ç»Ÿä¸­ social user -> sys user çš„ç»‘å®šå…³ç³»ï¼‰
     *
     * @param userInfo JustAuth ä¸­çš„ AuthUser
     * @return JapUser
     */
    @Override
    public JapUser createAndGetSocialUser(Object userInfo) {
        AuthUser authUser = (AuthUser) userInfo;
        // æŸ¥è¯¢ç»‘å®šå…³ç³»ï¼Œç¡®å®šå½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•è¿‡ä¸šåŠ¡ç³»ç»Ÿ
        JapUser japUser = this.getByPlatformAndUid(authUser.getSource(), authUser.getUuid());
        if (null == japUser) {
            japUser = createJapUser();
            japUser.setAdditional(authUser);
            userDatas.add(japUser);
        }
        return japUser;
    }

    /**
     * æ¨¡æ‹Ÿåˆ›å»ºç”¨æˆ·
     *
     * @return JapUser
     */
    private JapUser createJapUser() {
        JapUser user = new JapUser();
        user.setUserId("1");
        user.setUsername("jap");
        user.setPassword("jappassword");
        return user;
    }
}
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ *application.properties* ä¸­æŒ‡å®šsocialç­–ç•¥çš„`JapUserService`å®ç°ç±»ï¼Œå³æŒ‡å®šè¯¥å®ç°ç±»çš„åŒ…å…¨åï¼ˆbinary nameï¼‰ï¼š

```properties
jap.social-user-service=xyz.dong6662.japspringbootstarterdemo.service.SocialUserServiceImpl
```

### å®ç°Controller

```java
@RestController
@RequestMapping("/social")
public class SocialController {
    @Autowired
    SocialStrategy socialStrategy;
    @Autowired
    SocialProperties socialProperties;

    @RequestMapping("/aliyun")
    public JapResponse authenticate(HttpServletRequest request, HttpServletResponse response){
        return socialStrategy.authenticate(socialProperties.getSocial().get("aliyun"),request,response);
    }
}
```

## ä½¿ç”¨JapTemplate

è¿™æ˜¯ä¸ºäº†ç®€åŒ–å››ç§æˆæƒç­–ç•¥çš„è°ƒç”¨è€Œå¼€å‘çš„starterä¾èµ–ã€‚åªéœ€åœ¨å¼•å…¥äº†jap-socialçš„mavenä¾èµ–çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥ *JapTemplate*çš„ä¾èµ–ä¾¿å¯ä½¿ç”¨ï¼š

```xml
<dependency>
    <groupId>xyz.dong6662.jap.spring.boot</groupId>
    <artifactId>jap-spring-boot-starter-template</artifactId>
    <version>1.0.0</version>
</dependency>
```

è¿™æ ·ï¼Œåœ¨Controllerä¸­çš„æˆæƒä»£ç åªéœ€ä¸€è¡Œä¾¿å¯å®Œæˆæˆæƒï¼š

```java
@RestController
@RequestMapping("/social")
public class SocialController {
    @Autowired
    JapTemplate japTemplate;
    @Autowired
    JapUserStore japUserStore;

    @RequestMapping(method = RequestMethod.GET, path = "/gitee")
    public JapResponse giteeCallback() {
        return japTemplate.opsForSocial().authenticate("gitee");//è¿›è¡Œæˆæƒ
    }

    @RequestMapping("/gitee/user-info")
    public JapResponse userInfo(HttpServletRequest request, HttpServletResponse response){
        // japUserStoreå®ç°ç±»ä¸ºSessionJapUserStoreæ—¶ï¼Œè·å–çš„æ˜¯å½“å‰ä¼šè¯ä¿å­˜çš„AuthUser
        AuthUser authUser = (AuthUser) japUserStore.get(request, response).getAdditional();
        AuthToken token = authUser.getToken();
        return japTemplate.opsForSocial().getUserInfo("gitee", token);
    }

    @RequestMapping("/gitee/refresh-token")
    public JapResponse refreshToken(HttpServletRequest request, HttpServletResponse response){
        // å½“å‰ä¼šè¯ä¿å­˜çš„AuthUser
        AuthUser authUser = (AuthUser) japUserStore.get(request, response).getAdditional();
        AuthToken token = authUser.getToken();
        // FIXME: 2021/10/10 AuthGiteeRequestä¸­æ²¡æœ‰å®ç°refreshæ–¹æ³•ï¼Œæ­¤å¤„æš‚æ— æ³•æµ‹è¯•
        return japTemplate.opsForSocial().refreshToken("gitee",token);
    }

    // FIXME: 2021/10/10 åŒrefreshTokenï¼Œ AuthGiteeRequestï¼ˆme.zhyd.oauth.requeståŒ…ä¸‹ï¼‰ä¸­ä¹Ÿæ²¡æœ‰å®ç°revokeï¼Œæ•…æš‚ä¸æµ‹è¯•revokeToken

}
```

## å¼•å…¥Redisç¼“å­˜

socialæˆæƒç­–ç•¥ä¼šç¼“å­˜**state**ï¼Œå¯¹stateçš„æè¿°å¯å‚è€ƒ[jap-oauth2ï¼šoauthconfig-é…ç½®é¡¹](https://justauth.plus/quickstart/jap-oauth2/#oauthconfig-%E9%85%8D%E7%BD%AE%E9%A1%B9)ï¼š

> å®¢æˆ·ç«¯ç”¨äºç»´æŠ¤è¯·æ±‚å’Œå›è°ƒä¹‹é—´çš„çŠ¶æ€çš„ä¸é€æ˜å€¼ã€‚æˆæƒæœåŠ¡å™¨åœ¨å°†ç”¨æˆ·ä»£ç†é‡å®šå‘å›å®¢æˆ·ç«¯æ—¶åŒ…å«æ­¤å€¼

é»˜è®¤é‡‡ç”¨JustAuthæä¾›çš„ç¼“å­˜ï¼Œæœ¬starteræ”¯æŒRedisä½œä¸ºç¼“å­˜ã€‚è‹¥é‡‡ç”¨Redisï¼Œåˆ™éœ€è¦å¼•å…¥Redisçš„Spring Boot Starterï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

å¹¶åœ¨*application.properties*ä¸­å®Œæˆredisçš„ä¸€äº›åŸºæœ¬é…ç½®ï¼š

```properties
# redisåŸºç¡€é…ç½®
spring.redis.port=6379
spring.redis.host=127.0.0.1
spring.redis.timeout=3m
```

ç„¶åæŒ‡å®šRedisä½œä¸ºstateçš„ç¼“å­˜å³å¯ï¼š

```properties
# social ç¼“å­˜ç±»å‹
jap.social.cache.type=redis
```

