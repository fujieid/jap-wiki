---
title: jap-oidc-spring-boot-starter æ¨¡å—ä½¿ç”¨å¸®åŠ©
permalink: /starter/jap-oidc-spring-boot-starter/
sidebar: true
article: true
comment: true
categories:
- æŒ‡å—
- starter
  tags:
- jap-ids
- springboot
- starter
  date: 2021-10-12 14:05:06
---

# jap-oidc-spring-boot-starter

ä¸º[JustAuth Plus](https://justauth.plus/) çš„ ***oidc*** æˆæƒç­–ç•¥å¼€å‘çš„Spring Boot Starterä¾èµ–ã€‚

å¯è®¿é—®æœ¬starterçš„[demo](https://github.com/Vector6662/jap-spring-boot-starter-demo) ï¼ŒåŒ…å«è¾ƒä¸ºè¯¦å°½çš„è°ƒç”¨æµç¨‹å’Œç›¸å…³é…ç½®è¯´æ˜ã€‚

## å¼€æºä»“åº“åœ°å€ï¼š

[GitHub](https://github.com/fujieid/jap-spring-boot-starter)

[Gitee](https://gitee.com/fujieid/jap-spring-boot-starter-demo)

## å¿«é€Ÿå¼€å§‹

### å¼•å…¥ä¾èµ–

åœ¨ä½ é¡¹ç›®çš„ *pom.xml* æ–‡ä»¶ä¸­æ·»åŠ jap-oidcçš„starterçš„mavenä¾èµ–ï¼š

```xml
<dependency>
    <groupId>xyz.dong6662.jap.spring.boot</groupId>
    <artifactId>jap-oidc-spring-boot-starter</artifactId>
    <version>1.0.0</version>
</dependency>
```

### application.propertiesä¸­é…ç½®

é¦–å…ˆåœ¨ *application.properties* æ–‡ä»¶ä¸­å®Œæˆä¸€äº›åŸºæœ¬é…ç½®ï¼Œè¿™äº›é…ç½®ä¿¡æ¯æ‰€æœ‰æˆæƒç­–ç•¥å‡ä¼šä½¿ç”¨åˆ°ï¼š

```properties
# åŸºç¡€é…ç½®
# å¦‚æœå¯å¯ç”¨äº†ssoï¼Œåˆ™éœ€è¦å¯¹ssoè¿›è¡Œä¸€äº›é…ç½®
jap.basic.sso=false
jap.basic.cache-expire-time=12
jap.basic.token-expire-time=12
# sso
jap.sso.cookie-domain=xxx
jap.sso.cookie-max-age=xxx
jap.sso.cookie-name=xxx
```

ç„¶åï¼Œä¸ºoidcç­–ç•¥æ·»åŠ å®ƒçš„é…ç½®ä¿¡æ¯ï¼Œè¿™é‡Œä»¥[é˜¿é‡Œäº‘RAM](https://ram.console.aliyun.com/overview)ä¸ºä¾‹ï¼š

```properties
# oidcç­–ç•¥

# é˜¿é‡Œäº‘
jap.oidc.aliyun.platform=aliyun
jap.oidc.aliyun.client-id=4408723633922655083
jap.oidc.aliyun.client-secret=3u8PnaEQZjFHVzXdLcCoTAywpQEQ5anhZeW3NSO06lFYmiRuHNBzuz3FlO5u3ihP
jap.oidc.aliyun.issuer=https://oauth.aliyun.com
jap.oidc.aliyun.authorization-url=https://signin.aliyun.com/oauth2/v1/auth
jap.oidc.aliyun.callback-url=http://localhost:8080/oidc/aliyun
jap.oidc.aliyun.token-url=https://oauth.aliyun.com/v1/token
jap.oidc.aliyun.verify-state=false
jap.oidc.aliyun.grant-type=authorization_code
jap.oidc.aliyun.response-type=code
jap.oidc.aliyun.refresh-token-url=https://oauth.aliyun.com/v1/token
jap.oidc.aliyun.revoke-token-url=https://oauth.aliyun.com/v1/revoke
#jap.oidc.aliyun.scopes=aliuid,openid,profiles
```

### å®ç°JapUserServiceæ¥å£

ä¸jap-oidcå®ç°JapUserServiceæ¥å£ä¸åŒçš„æ˜¯ï¼ŒğŸˆ**ä½ ä¸ä»…éœ€è¦ä¸ºè¯¥å®ç°ç±»æ·»åŠ `@Service`æ³¨è§£ï¼Œè¿˜éœ€è¦å¯¹è¯¥æ³¨è§£æ·»åŠ å‚æ•°`JapUserServiceType.OIDC`**ï¼Œè¡¨æ˜è¿™æ˜¯oauth2ç­–ç•¥çš„å®ç°ç±»ï¼š

```java
@Service(JapUserServiceType.OIDC)
public class OidcUserServiceImpl implements JapUserService {

    /**
     * æ¨¡æ‹Ÿ DB æ“ä½œ
     */
    private static final List<JapUser> userDatas = Lists.newArrayList();

    /**
     * æ ¹æ®ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†ï¼ˆplatformï¼‰å’Œç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ· uid æŸ¥è¯¢æ•°æ®åº“
     *
     * @param platform ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†
     * @param uid      ç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ· uid
     * @return JapUser
     */
    @Override
    public JapUser getByPlatformAndUid(String platform, String uid) {
        return null;
    }

    /**
     * åˆ›å»ºå¹¶è·å–ç¬¬ä¸‰æ–¹ç”¨æˆ·ï¼Œç›¸å½“äºç¬¬ä¸‰æ–¹ç™»å½•æˆåŠŸåï¼Œå°†æˆæƒå…³ç³»ä¿å­˜åˆ°æ•°æ®åº“
     * ï¼ˆå¼€å‘è€…ä¸šåŠ¡ç³»ç»Ÿä¸­ oauth2 user -> sys user çš„ç»‘å®šå…³ç³»ï¼‰
     *
     * @param platform ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†
     * @param userInfo ç¬¬ä¸‰æ–¹è¿”å›çš„ç”¨æˆ·ä¿¡æ¯
     * @param tokenInfo token ä¿¡æ¯ï¼Œå¯ä»¥å¼ºåˆ¶è½¬æ¢ä¸º com.fujieid.jap.oauth2.token.AccessToken
     * @return JapUser
     */
    @Override
    public JapUser createAndGetOauth2User(String platform, Map<String, Object> userInfo, Object tokenInfo) {
        // FIXME ä¸šåŠ¡ç«¯å¯ä»¥å¯¹ tokenInfo è¿›è¡Œä¿å­˜æˆ–å…¶ä»–æ“ä½œ
        AccessToken accessToken = (AccessToken) tokenInfo;
        System.out.println(JsonUtil.toJsonString(accessToken));
        // FIXME æ³¨æ„ï¼šæ­¤å¤„ä»…ä½œæ¼”ç¤ºç”¨ï¼Œä¸åŒçš„ oauth å¹³å°ç”¨æˆ·idéƒ½ä¸ä¸€æ ·ï¼Œ
        // æ­¤å¤„éœ€è¦å¼€å‘è€…è‡ªå·±åˆ†æç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæå–å‡ºç”¨æˆ·çš„å”¯ä¸€ID
        String uid = (String) userInfo.get("userId");
        // æŸ¥è¯¢ç»‘å®šå…³ç³»ï¼Œç¡®å®šå½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•è¿‡ä¸šåŠ¡ç³»ç»Ÿ
        JapUser japUser = this.getByPlatformAndUid(platform, uid);
        if (null == japUser) {
            // ä¿å­˜ç”¨æˆ·
            japUser = createJapUser();
            japUser.setAdditional(userInfo);
            userDatas.add(japUser);
        }
        return japUser;
    }

    private JapUser createJapUser() {
        JapUser user = new JapUser();
        user.setUserId("1");
        user.setUsername("justauth");
        user.setPassword("justauthpassword");
        return user;
    }
}
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ *application.properties* ä¸­æŒ‡å®šoidcç­–ç•¥çš„`JapUserService`å®ç°ç±»ï¼Œå³æŒ‡å®šè¯¥å®ç°ç±»çš„åŒ…å…¨åï¼ˆbinary nameï¼‰ï¼š

```properties
jap.oidc-user-service=xyz.dong6662.japspringbootstarterdemo.service.OidcUserServiceImpl
```

### å®ç°Controller

```java
@RestController
@RequestMapping("/oidc")
public class OidcController {
    @Autowired
    OidcStrategy oidcStrategy;
    @Autowired
    OidcProperties oidcProperties;

    @RequestMapping("/aliyun")
    public JapResponse aliyunCallback(HttpServletRequest request, HttpServletResponse response){
        return oidcStrategy.authenticate(oidcProperties.getOidc().get("aliyun"),request,response);
    }
}
```

## ä½¿ç”¨JapTemplate

è¿™æ˜¯ä¸ºäº†ç®€åŒ–å››ç§æˆæƒç­–ç•¥çš„è°ƒç”¨è€Œå¼€å‘çš„starterä¾èµ–ã€‚åªéœ€åœ¨å¼•å…¥äº†jap-oidcçš„mavenä¾èµ–çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥ *JapTemplate*çš„ä¾èµ–ä¾¿å¯ä½¿ç”¨ï¼š

```xml
<dependency>
    <groupId>xyz.dong6662.jap.spring.boot</groupId>
    <artifactId>jap-spring-boot-starter-template</artifactId>
    <version>1.0.0</version>
</dependency>
```

è¿™æ ·ï¼Œåœ¨Controllerä¸­çš„æˆæƒä»£ç åªéœ€ä¸€è¡Œä¾¿å¯å®Œæˆæˆæƒï¼š

```java
@RestController
@RequestMapping("/oidc")
public class OidcController {
    @Autowired
    JapTemplate japTemplate;

    @RequestMapping("/aliyun")
    public JapResponse aliyunCallback(){
        return japTemplate.opsForOidc().authenticate("aliyun");
    }
}
```

## å¼•å…¥Redisç¼“å­˜

oauth2å’Œoidcæˆæƒç­–ç•¥éƒ½ä¼šç¼“å­˜tokenï¼Œé™¤äº†é»˜è®¤çš„ç¼“å­˜ç±»å‹ï¼ˆdefaultï¼‰å¤–ï¼Œæœ¬starterè¿˜æ”¯æŒRedisä½œä¸ºç¼“å­˜ã€‚è‹¥é‡‡ç”¨Redisæ–¹å¼ï¼Œéœ€è¦å¼•å…¥Redisçš„Spring Boot Starterï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

å¹¶åœ¨*application.properties*ä¸­å®Œæˆredisçš„ä¸€äº›åŸºæœ¬é…ç½®ï¼š

```properties
# redisåŸºç¡€é…ç½®
spring.redis.port=6379
spring.redis.host=127.0.0.1
spring.redis.timeout=3m
```

ç„¶åæŒ‡å®šRedisä½œä¸ºtokençš„ç¼“å­˜å³å¯ï¼š

```properties
# tokenç¼“å­˜
jap.cache.token.type=redis
jap.cache.token.expire-time=3m
```

## æ‰©å±•é˜…è¯»

é˜¿é‡Œäº‘æ–‡æ¡£ï¼š[é€šè¿‡OIDCè·å–ç”¨æˆ·ä¿¡æ¯](https://help.aliyun.com/document_detail/93698.html)